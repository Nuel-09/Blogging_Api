<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Blogs - BlogHub</title>
  <link rel="stylesheet" href="/public/css/style.css">
</head>
<body>
  <header class="navbar">
    <div class="container">
      <div class="navbar-brand">
        <h1><a href="/">üìù BlogHub</a></h1>
      </div>
      <nav class="navbar-nav">
        <a href="/" class="nav-link">Explore</a>
        <a href="/dashboard" class="nav-link active">My Blogs</a>
        <a href="/blogs/new" class="nav-link btn btn-primary">Write Blog</a>
        <button onclick="handleLogout()" class="nav-link btn btn-logout">Logout (<%= user.first_name %>)</button>
      </nav>
    </div>
  </header>

  <main class="main-content">
    <div class="container">
      <!-- Dashboard Header -->
      <section class="dashboard-header">
        <h2>My Blogs</h2>
        <a href="/blogs/new" class="btn btn-primary">‚úèÔ∏è Write New Blog</a>
      </section>

      <!-- Filters -->
      <section class="filter-section">
        <form method="GET" class="filter-form">
          <div class="filter-group">
            <label for="state">Filter by State:</label>
            <select name="state" class="filter-select">
              <option value="">All Blogs</option>
              <option value="draft" <%= state === 'draft' ? 'selected' : '' %>>Draft</option>
              <option value="published" <%= state === 'published' ? 'selected' : '' %>>Published</option>
            </select>
            <button type="submit" class="btn btn-secondary">Filter</button>
          </div>
        </form>
      </section>

      <!-- My Blogs List -->
      <section class="my-blogs">
        <% if (blogs.data && blogs.data.length > 0) { %>
          <div class="blogs-table">
            <table>
              <thead>
                <tr>
                  <th>Title</th>
                  <th>State</th>
                  <th>Views</th>
                  <th>Created</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% blogs.data.forEach(blog => { %>
                  <tr>
                    <td>
                      <strong><a href="/blogs/<%= blog._id %>"><%= blog.title %></a></strong>
                    </td>
                    <td>
                      <span class="badge <%= blog.state === 'published' ? 'badge-success' : 'badge-warning' %>">
                        <%= blog.state %>
                      </span>
                    </td>
                    <td><%= blog.read_count %></td>
                    <td><%= new Date(blog.createdAt).toLocaleDateString() %></td>
                    <td class="actions">
                      <a href="/blogs/<%= blog._id %>/edit" class="btn btn-sm btn-primary">Edit</a>
                      <button onclick="toggleBlogState('<%= blog._id %>', '<%= blog.state %>')" class="btn btn-sm btn-secondary">
                        <%= blog.state === 'draft' ? 'Publish' : 'Unpublish' %>
                      </button>
                      <button onclick="deleteBlog('<%= blog._id %>')" class="btn btn-sm btn-danger">Delete</button>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <% if (blogs.pagination && blogs.pagination.totalPages > 1) { %>
            <section class="pagination">
              <% if (blogs.pagination.currentPage > 1) { %>
                <a href="/dashboard?page=1" class="page-link">¬´ First</a>
                <a href="/dashboard?page=<%= blogs.pagination.currentPage - 1 %>" class="page-link">‚Äπ Previous</a>
              <% } %>
              
              <span class="page-info">
                Page <%= blogs.pagination.currentPage %> of <%= blogs.pagination.totalPages %>
              </span>
              
              <% if (blogs.pagination.currentPage < blogs.pagination.totalPages) { %>
                <a href="/dashboard?page=<%= blogs.pagination.currentPage + 1 %>" class="page-link">Next ‚Ä∫</a>
                <a href="/dashboard?page=<%= blogs.pagination.totalPages %>" class="page-link">Last ¬ª</a>
              <% } %>
            </section>
          <% } %>
        <% } else { %>
          <div class="no-blogs">
            <p>You haven't written any blogs yet!</p>
            <a href="/blogs/new" class="btn btn-primary">Start Writing</a>
          </div>
        <% } %>
      </section>
    </div>
  </main>

  <footer class="footer">
    <div class="container">
      <p>&copy; 2026 BlogHub. Built with ‚ù§Ô∏è for writers.</p>
    </div>
  </footer>

  <script>
    async function toggleBlogState(blogId, currentState) {
      const newState = currentState === 'draft' ? 'published' : 'draft';
      
      try {
        const response = await fetch(`/api/blogs/${blogId}/state`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ state: newState })
        });

        const data = await response.json();

        if (response.ok && data.success) {
          alert(`Blog ${newState === 'published' ? 'published' : 'unpublished'} successfully!`);
          window.location.reload();
        } else {
          alert(data.data?.error || data.error || 'Failed to update blog state');
        }
      } catch (err) {
        console.error('Error updating blog state:', err);
        alert('An error occurred. Please try again.');
      }
    }

    async function deleteBlog(blogId) {
      if (!confirm('Are you sure you want to delete this blog?')) {
        return;
      }

      try {
        console.log('üóëÔ∏è DELETE request starting for blogId:', blogId);
        const url = `/api/blogs/${blogId}`;
        console.log('üìç URL:', url);
        
        const response = await fetch(url, {
          method: 'DELETE',
          credentials: 'include'
        });

        console.log('üì• Response received:', response.status, response.statusText);
        
        const data = await response.json();
        console.log('üì¶ Response data:', data);

        if (response.ok && data.success) {
          alert('Blog deleted successfully!');
          window.location.reload();
        } else {
          console.log('‚ùå Delete failed - response not ok or no success flag');
          alert(data.data?.error || data.error || 'Failed to delete blog');
        }
      } catch (err) {
        console.error('üí• Error deleting blog:', err);
        console.error('Error message:', err.message);
        console.error('Error stack:', err.stack);
        alert('An error occurred. Please try again.');
      }
    }

    async function handleLogout() {
      try {
        const response = await fetch('/api/auth/logout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({})
        });
        
        if (response.ok) {
          window.location.href = '/';
        } else {
          alert('Logout failed');
        }
      } catch (err) {
        console.error('Logout error:', err);
        alert('An error occurred during logout');
      }
    }
  </script>
</body>
</html>
